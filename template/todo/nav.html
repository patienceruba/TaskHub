{% load static %}
<nav>
    <h1><a href="{% url 'dashboard' %}">DoiZ</a></h1>
    <div class="nav">
        <form method="GET" action="{% url 'search' %}">
            {% if request.path == '/event' or request.path == '/home' or request.path == '/list_teams' %}

                <div class="search-container">
                    <div class="search-input-container">
                        <span class="material-symbols-outlined search-icon">search</span>
                        <input type="hidden" name="redirect" value="{{ redirect_to }}">
                        <input type="search" name="search" value="{{ query }}" placeholder="Search..." id="search" required>
                    </div>
                </div>
            {% endif %}
        </form>

        <div class="nav-icons">
            <!-- Notification Bell -->
            <div class="notification-bell" id="notification-bell">
                <span class="material-symbols-outlined">notifications</span>
                <span class="badge" id="notification-count">0</span>

                <!-- Notification Dropdown -->
                <div class="notification-dropdown" id="notification-dropdown">
                    <p class="empty">No notifications</p>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown">
                <img src="{% if user.userprofile.profile_picture %}{{ user.userprofile.profile_picture.url }}{% else %}{% static 'image/User-Account-Person-PNG-File.png' %}{% endif %}"
                     alt="{{ user.username }}'s profile picture" width="30" height="30" id="profile-pic">

                <div class="dropdown-menu" id="profile-dropdown">
                    <h4>{{ user.username }}</h4>
                    <a href="{% url 'profile' %}">Edit Profile</a>
                    <a href="{% url 'person' %}">Person info</a>
                    <a href="{% url 'change_passwd' %}">Change password</a>
                    {% if request.user.is_superuser %}
                        <a href="{% url 'register' %}">Register user</a>
                        <a href="{% url 'add_image' %}">Add login slide image</a>
                    {% endif %}
                    <a href="{% url 'logout' %}">Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- CSS -->
<style>
.nav-icons { display: flex; align-items: center; gap: 15px; }
.notification-bell { position: relative; display: inline-block; cursor: pointer; }
.notification-bell .material-symbols-outlined { font-size: 26px; color: white; }
.badge { position: absolute; top: -5px; right: -10px; background-color: red; color: white; font-size: 12px; padding: 2px 6px; border-radius: 50%; display: none; }
.profile-dropdown { position: relative; display: inline-block; cursor: pointer; }
#profile-pic { border-radius: 50%; }
#profile-pic:hover { outline: 2px solid #3fc1c9; transition: 0.2s ease; }
.dropdown-menu { position: absolute; right: 0; top: 40px; background-color: #062a30; box-shadow: 0px 8px 16px rgba(0,0,0,0.25); border-radius: 10px; min-width: 160px; z-index: 1000; padding: 10px 0; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease-in-out; }
.dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
.dropdown-menu::before { content: ''; position: absolute; top: -10px; right: 14px; border-width: 5px; border-style: solid; border-color: transparent transparent #062a30 transparent; }
.dropdown-menu h4 { color: #fff; padding: 8px 16px; margin: 0; font-weight: normal; font-size: 14px; }
.dropdown-menu a { display: block; padding: 10px 16px; text-decoration: none; color: rgb(253, 245, 245); font-size: 14px; }
.dropdown-menu a + a { border-top: 1px solid #1b4b50; }
.dropdown-menu a:hover { background-color: #2c3e50; }
.notification-dropdown { position: absolute; top: 35px; right: 0; width: 250px; background-color: #062a30; color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: none; z-index: 1000; overflow: hidden; max-height: 300px; overflow-y: auto; }
.notification-dropdown.show { display: block; }
.notification-dropdown p, .notification-dropdown div { padding: 10px; border-bottom: 1px solid #1b4b50; }
.notification-dropdown p.empty { text-align: center; color: #aaa; }
.notification-dropdown div:hover { background-color: #1a4b50; cursor: pointer; }
.notification-text { flex-grow: 1; }
.mark-read-btn { background: #3fc1c9; border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; text-align: center; padding: 0; margin-left: 5px; }
.mark-read-btn:disabled { opacity: 0.5; cursor: default; }
</style>

<!-- JS -->
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', () => {
    const notificationBell = document.getElementById("notification-bell");
    const notificationDropdown = document.getElementById("notification-dropdown");
    const notificationCountBadge = document.getElementById('notification-count');
    const profilePic = document.getElementById("profile-pic");
    const dropdownMenu = document.getElementById("profile-dropdown");

    function createNotificationItem(n) {
        if (n.is_read) return null;

        const item = document.createElement('div');
        item.dataset.id = n.id;
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.padding = '10px';
        item.style.borderBottom = '1px solid #1b4b50';
        item.style.backgroundColor = '#062a30';
        item.style.cursor = 'pointer';

        const textSpan = document.createElement('span');
        textSpan.className = 'notification-text';
        textSpan.textContent = n.message_content || n.message || n.title || 'New notification';
        item.appendChild(textSpan);

        const markReadBtn = document.createElement('button');
        markReadBtn.className = 'mark-read-btn';
        markReadBtn.textContent = 'âœ“';
        markReadBtn.title = 'Mark as read';

        markReadBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
                await fetch(`/api/notifications/${n.id}/mark-read/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
                });
                item.remove();
                let count = parseInt(notificationCountBadge.textContent) || 0;
                count = Math.max(0, count - 1);
                notificationCountBadge.textContent = count;
                notificationCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
            } catch (err) {
                console.error(err);
            }
        });

        item.appendChild(markReadBtn);
        return item;
    }

    async function fetchNotifications() {
        try {
            const res = await fetch('/api/unread-notifications/');
            if (!res.ok) throw new Error('Failed to fetch notifications');
            const data = await res.json();

            notificationCountBadge.textContent = data.unread_count || 0;
            notificationCountBadge.style.display = data.unread_count > 0 ? 'inline-block' : 'none';

            notificationDropdown.innerHTML = '';
            if (!data.notifications.length) {
                notificationDropdown.innerHTML = '<p class="empty">No notifications</p>';
            } else {
                data.notifications.forEach(n => {
                    const item = createNotificationItem(n);
                    if (item) notificationDropdown.appendChild(item);
                });
            }
        } catch (err) {
            console.error(err);
        }
    }

    fetchNotifications();

    notificationBell.addEventListener('click', e => {
        notificationDropdown.classList.toggle('show');
        e.stopPropagation();
        if (notificationDropdown.classList.contains('show')) {
            notificationCountBadge.style.display = 'none';
        }
    });

    profilePic.addEventListener('click', e => {
        dropdownMenu.classList.toggle("show");
        e.stopPropagation();
    });

    document.addEventListener('click', e => {
        if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.classList.remove('show');
        }
        if (!profilePic.contains(e.target) && !dropdownMenu.contains(e.target)) {
            dropdownMenu.classList.remove('show');
        }
    });

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const notificationsSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

    notificationsSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.is_read) return;

        let count = parseInt(notificationCountBadge.textContent) || 0;
        count += 1;
        notificationCountBadge.textContent = count;
        notificationCountBadge.style.display = 'inline-block';

        if (notificationDropdown.querySelector('p.empty')) {
            notificationDropdown.innerHTML = '';
        }

        const newItem = createNotificationItem(data);
        if (newItem) notificationDropdown.insertBefore(newItem, notificationDropdown.firstChild);
    };

    notificationsSocket.onclose = function() {
        console.error('Notification socket closed. Reconnecting in 5s...');
        setTimeout(() => location.reload(), 5000);
    };
});
</script>
